[tools]
uv = "0.9"

[tasks.setup]
description = "Install dependencies"
run = "uv sync"

[tasks.format]
description = "Format code with Ruff"
run = "uv run ruff format . && uv run ruff check . --fix"

[tasks.test]
description = "Run tests"
run = "uv run pytest"

[tasks.check]
description = "Run linting and type checking"
run = "uv run ruff format --check . && uv run ruff check . && uv run mypy ."

[tasks.build]
description = "Build Lambda deployment package"
run = """
rm -rf dist function.zip
uv export --frozen --no-dev --no-editable -o requirements.txt
uv pip install -r requirements.txt --target dist \
   --no-installer-metadata \
   --no-compile-bytecode \
   --python-platform x86_64-manylinux2014
cp -r gtfs_translation dist/
# Explicitly remove any lingering boto-related files
# Use a broad glob to catch everything in dist/ that looks like boto or botocore
# Remove __pycache__ and other unnecessary files
find dist -name "__pycache__" -type d -exec rm -rf {} +
find dist -name "*.pyc" -type d -exec rm -rf {} +
# Use deterministic zipping:
# -X: no extra file attributes (UID/GID)
# -r: recursive
# -y: preserve symlinks
# -o: set zip file time to latest file time
# find ... -exec touch: set all file times to a fixed epoch
find dist -exec touch -h -t 202601010000 {} +
cd dist && zip -Xroy ../function.zip .
cd ..
rm -rf dist requirements.txt
"""

[tasks.run-local]
description = "Run translation locally and print to stdout"
run = "uv run python scripts/run_local.py"
